<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ÄÄƒng kÃ½ cá»™ng tÃ¡c viÃªn - Mr.Tattoo Hanoi</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .container { max-width: 600px; margin: auto; }
    .form-group { 
  margin-bottom: 15px; 
  position: relative; 
  display: flex; 
  align-items: center; 
}
label { display: block; margin-bottom: 5px; }
input { width: 100%; padding: 8px 30px 8px 8px; box-sizing: border-box; }
button { padding: 10px 20px; background-color: #4CAF50; color: white; border: none; cursor: pointer; }
button:hover { background-color: #45a049; }
.error { color: red; font-size: 0.9em; display: none; }
.eye-icon { 
  position: absolute; 
  right: 8px; 
  top: 50%; 
  transform: translateY(-50%); 
  cursor: pointer; 
  font-size: 18px; 
  line-height: 1; /* Äáº£m báº£o icon khÃ´ng bá»‹ lá»‡ch do line-height */
}
  </style>
</head>
<body>
  <div class="container">
    <h1>ÄÄƒng kÃ½ cá»™ng tÃ¡c viÃªn - Mr.Tattoo Hanoi</h1>
    <form id="register-form">
      <div class="form-group">
        <label for="username">TÃªn Ä‘Äƒng nháº­p</label>
        <input type="text" id="username" placeholder="TÃªn Ä‘Äƒng nháº­p" required>
        <span id="username-error" class="error"></span>
      </div>
      <div class="form-group">
        <label for="password">Máº­t kháº©u</label>
        <input type="password" id="password" placeholder="Máº­t kháº©u (Ã­t nháº¥t 6 kÃ½ tá»±, cÃ³ kÃ½ tá»± Ä‘áº·c biá»‡t)" required>
        <span id="password-eye" class="eye-icon">ğŸ‘ï¸</span>
        <span id="password-error" class="error"></span>
      </div>
      <div class="form-group">
        <label for="confirm-password">Nháº¯c láº¡i máº­t kháº©u</label>
        <input type="password" id="confirm-password" placeholder="Nháº¯c láº¡i máº­t kháº©u" required>
        <span id="confirm-password-eye" class="eye-icon">ğŸ‘ï¸</span>
        <span id="confirm-password-error" class="error"></span>
      </div>
      <div class="form-group">
        <label for="name">Há» vÃ  tÃªn</label>
        <input type="text" id="name" placeholder="Há» vÃ  tÃªn" required>
        <span id="name-error" class="error"></span>
      </div>
      <div class="form-group">
        <label for="phone">Sá»‘ Ä‘iá»‡n thoáº¡i</label>
        <input type="text" id="phone" placeholder="Sá»‘ Ä‘iá»‡n thoáº¡i (báº¯t Ä‘áº§u báº±ng 03, 05, 07, 08, 09)" required>
        <span id="phone-error" class="error"></span>
      </div>
      <div class="form-group">
        <label for="email">Email</label>
        <input type="email" id="email" placeholder="Email" required>
        <span id="email-error" class="error"></span>
      </div>
      <button type="submit">ÄÄƒng kÃ½</button>
    </form>
    <p id="form-error" class="error"></p>
  </div>

  <script>
// Láº¥y API key tá»« k.txt
async function getApiKey() {
  try {
    const response = await fetch('https://raw.githubusercontent.com/mrtattoo-hanoi/CTV/refs/heads/main/k.txt');
    const text = await response.text();
    const lines = text.split('\n').filter(line => line.trim() !== '');
    return lines.join('');
  } catch (error) {
    console.error('Lá»—i khi láº¥y API key:', error);
    return null;
  }
}

// Xá»­ lÃ½ hiá»ƒn thá»‹/áº©n máº­t kháº©u
function togglePasswordVisibility(inputId, eyeId) {
  const input = document.getElementById(inputId);
  const eye = document.getElementById(eyeId);
  eye.addEventListener('click', () => {
    if (input.type === 'password') {
      input.type = 'text';
      eye.textContent = 'ğŸ™ˆ';
    } else {
      input.type = 'password';
      eye.textContent = 'ğŸ‘ï¸';
    }
  });
}

togglePasswordVisibility('password', 'password-eye');
togglePasswordVisibility('confirm-password', 'confirm-password-eye');

// Kiá»ƒm tra dá»¯ liá»‡u Ä‘áº§u vÃ o
function validateForm(data) {
  const errors = {};
  const specialCharRegex = /[@#$!%^&*]/;
  const phoneRegex = /^(03|05|07|08|09)\d{8}$/;

  if (!data.username || data.username.length < 3) {
    errors.username = 'TÃªn Ä‘Äƒng nháº­p pháº£i cÃ³ Ã­t nháº¥t 3 kÃ½ tá»±!';
  }
  if (!data.password || data.password.length < 6 || !specialCharRegex.test(data.password)) {
    errors.password = 'Máº­t kháº©u pháº£i cÃ³ Ã­t nháº¥t 6 kÃ½ tá»± vÃ  chá»©a Ã­t nháº¥t 1 kÃ½ tá»± Ä‘áº·c biá»‡t (@#$!%^&*)!';
  }
  if (data.password !== data.confirmPassword) {
    errors.confirmPassword = 'Máº­t kháº©u khÃ´ng khá»›p!';
  }
  if (!data.name || data.name.length < 2) {
    errors.name = 'Há» vÃ  tÃªn pháº£i cÃ³ Ã­t nháº¥t 2 kÃ½ tá»±!';
  }
  if (!data.phone || !phoneRegex.test(data.phone) || data.phone.length !== 10) {
    errors.phone = 'Sá»‘ Ä‘iá»‡n thoáº¡i pháº£i cÃ³ Ä‘Ãºng 10 chá»¯ sá»‘ vÃ  báº¯t Ä‘áº§u báº±ng 03, 05, 07, 08, hoáº·c 09!';
  }
  if (!data.email || !/@/.test(data.email)) {
    errors.email = 'Email pháº£i há»£p lá»‡ vÃ  chá»©a kÃ½ tá»± @!';
  }

  return errors;
}

// Kiá»ƒm tra máº­t kháº©u thá»i gian thá»±c
function validateConfirmPasswordRealtime() {
  const password = document.getElementById('password').value;
  const confirmPassword = document.getElementById('confirm-password').value;
  const confirmError = document.getElementById('confirm-password-error');
  
  if (confirmPassword && password !== confirmPassword) {
    confirmError.textContent = 'Máº­t kháº©u khÃ´ng khá»›p!';
    confirmError.style.display = 'block';
  } else {
    confirmError.textContent = '';
    confirmError.style.display = 'none';
  }
}

// Táº¡o ID má»›i cho cá»™ng tÃ¡c viÃªn
function generateCollaboratorId(currentCollaborators) {
  const lastId = currentCollaborators.length > 0
    ? parseInt(currentCollaborators[currentCollaborators.length - 1].id.replace('T-', ''))
    : 1000;
  if (lastId >= 9999) {
    throw new Error('ÄÃ£ Ä‘áº¡t sá»‘ lÆ°á»£ng cá»™ng tÃ¡c viÃªn tá»‘i Ä‘a (T-9999)!');
  }
  return `T-${(lastId + 1).toString().padStart(4, '0')}`;
}

// HÃ m mÃ£ hÃ³a an toÃ n cho btoa
function safeBtoa(str) {
  const encoder = new TextEncoder();
  const data = encoder.encode(str);
  const binary = String.fromCharCode(...data);
  return btoa(binary);
}

// Xá»­ lÃ½ form Ä‘Äƒng kÃ½
document.getElementById('register-form').addEventListener('submit', async (e) => {
  e.preventDefault();
  const formError = document.getElementById('form-error');
  formError.style.display = 'none';

  // XÃ³a thÃ´ng bÃ¡o lá»—i cÅ©
  ['username', 'password', 'confirm-password', 'name', 'phone', 'email'].forEach(key => {
    const errorElement = document.getElementById(`${key}-error`);
    errorElement.textContent = '';
    errorElement.style.display = 'none';
  });

  // Láº¥y dá»¯ liá»‡u tá»« form
  const formData = {
    username: document.getElementById('username').value.trim(),
    password: document.getElementById('password').value,
    confirmPassword: document.getElementById('confirm-password').value,
    name: document.getElementById('name').value.trim(),
    phone: document.getElementById('phone').value.trim(),
    email: document.getElementById('email').value.trim()
  };

  // Kiá»ƒm tra dá»¯ liá»‡u Ä‘áº§u vÃ o
  const errors = validateForm(formData);
  Object.keys(errors).forEach(key => {
    const errorElement = document.getElementById(`${key}-error`);
    errorElement.textContent = errors[key];
    errorElement.style.display = 'block';
  });

  if (Object.keys(errors).length > 0) {
    return;
  }

  // Láº¥y API key
  const GITHUB_TOKEN = await getApiKey();
  if (!GITHUB_TOKEN) {
    formError.textContent = 'Lá»—i khi láº¥y API key!';
    formError.style.display = 'block';
    return;
  }

  try {
    // Láº¥y ná»™i dung file CTV.json
    const response = await fetch('https://api.github.com/repos/mrtattoo-hanoi/CTV/contents/CTV.json', {
      headers: {
        'Authorization': `Bearer ${GITHUB_TOKEN}`,
        'Accept': 'application/vnd.github+json'
      }
    });
    const fileData = await response.json();
    const content = JSON.parse(atob(fileData.content));

    // Kiá»ƒm tra trÃ¹ng username vÃ  phone
    if (content.collaborators.some(collab => collab.userName === formData.username)) {
      document.getElementById('username-error').textContent = 'TÃªn Ä‘Äƒng nháº­p Ä‘Ã£ tá»“n táº¡i!';
      document.getElementById('username-error').style.display = 'block';
      return;
    }
    if (content.collaborators.some(collab => collab.phone === formData.phone)) {
      document.getElementById('phone-error').textContent = 'Sá»‘ Ä‘iá»‡n thoáº¡i Ä‘Ã£ Ä‘Æ°á»£c sá»­ dá»¥ng!';
      document.getElementById('phone-error').style.display = 'block';
      return;
    }

    // Táº¡o cá»™ng tÃ¡c viÃªn má»›i
    const newCollaborator = {
      id: generateCollaboratorId(content.collaborators),
      userName: formData.username,
      pass: formData.password, // LÆ°u Ã½: NÃªn mÃ£ hÃ³a máº­t kháº©u trong thá»±c táº¿
      name: formData.name,
      email: formData.email,
      phone: formData.phone,
      total_commission: 0,
      transactions: []
    };

    // ThÃªm cá»™ng tÃ¡c viÃªn vÃ o danh sÃ¡ch
    content.collaborators.push(newCollaborator);

    // Cáº­p nháº­t file CTV.json trÃªn GitHub
    await fetch('https://api.github.com/repos/mrtattoo-hanoi/CTV/contents/CTV.json', {
      method: 'PUT',
      headers: {
        'Authorization': `Bearer ${GITHUB_TOKEN}`,
        'Accept': 'application/vnd.github+json'
      },
      body: JSON.stringify({
        message: `ThÃªm cá»™ng tÃ¡c viÃªn ${newCollaborator.id}`,
        content: safeBtoa(JSON.stringify(content, null, 2)),
        sha: fileData.sha
      })
    });

    alert('ÄÄƒng kÃ½ thÃ nh cÃ´ng! ID cá»§a báº¡n lÃ : ' + newCollaborator.id);
    document.getElementById('register-form').reset();
    // XÃ³a thÃ´ng bÃ¡o lá»—i sau khi Ä‘Äƒng kÃ½ thÃ nh cÃ´ng
    ['username', 'password', 'confirm-password', 'name', 'phone', 'email'].forEach(key => {
      document.getElementById(`${key}-error`).style.display = 'none';
    });
  } catch (error) {
    formError.textContent = 'Lá»—i khi Ä‘Äƒng kÃ½: ' + error.message;
    formError.style.display = 'block';
  }
});

// Kiá»ƒm tra máº­t kháº©u thá»i gian thá»±c
document.getElementById('confirm-password').addEventListener('input', validateConfirmPasswordRealtime);
document.getElementById('password').addEventListener('input', validateConfirmPasswordRealtime);
</script>
  </script>
</body>
</html>
